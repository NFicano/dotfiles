#!/usr/bin/env bash
# dots - utility for managing dotfiles
set -e

edit_bash_profile () {
  bash_profile="$(get_dotfiles_path)/bash_profile"
  open_file_with_preferred_editor "$bash_profile"
}

open_file_with_preferred_editor () {
  ${VISUAL:-${EDITOR:-vim}} $1
}

get_dotfiles_path () {
  fp="$(readlink -f ${0})"
  dir=$(dirname $fp)
  cd $dir || exit 1
  echo "$(git rev-parse --show-toplevel)"
}

show_usage () {
  echo "Usage: dots [OPTION]..."
  echo "Try 'dots --help' for more information."
}

show_unknown_command () {
  echo "ERROR: unknown command \"$1\""
  echo "Try 'dots --help' for more information."
}

get_latest_version () {
  curl -s https://api.github.com/repos/nficano/dotfiles/tags | jq -r '.[0].name'
}

check_for_updates () {
  latest="$(get_latest_version)"
  installed="v$DOTFILES_VERSION"
  if [ "$latest" = "$installed" ]; then
    echo "You're up-to-date! -" \
     "nficano/dotfiles $installed is the newest version available."
  else
    echo "New version available! -" \
      "nficano/dotfiles $latest is ready to be installed."
  fi
}

show_help () {
cat <<EOF

dots â€“ utility for managing dotfiles

Commands:
  -help|-h          displays help and usage.
  -editprofile      opens bash_profile in your preferred editor.
  -checkforupdates  checks if your dotfiles are up-to-date.
EOF
}

get_commands () {
  echo "$(show_help)" | grep -o '\-[a-z]*'
}

case "$@" in
  "-editprofile"           ) edit_bash_profile ;;
  "--help"                 ) show_help; exit 0 ;;
  "-checkforupdates"       ) check_for_updates ;;
  "-listcommands"          ) get_commands; exit 0 ;;
  "-h"                     ) show_help; exit 0 ;;
  ""                       ) show_usage; exit 0 ;;
  *                        ) show_unknown_command "$@"; exit 1 ;;
esac
exit 0
